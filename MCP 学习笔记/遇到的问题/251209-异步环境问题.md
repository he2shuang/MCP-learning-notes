由于在异步环境中，存在多个上下文管理器（context managers），连接建立方式需要调整。使用`AsyncExitStack`来管理读写连接，同时管控整个会话连接。


```
flowchart TD
    A[遇到一个函数调用] --> B{第一步：查文档/看提示<br>函数有 async 前缀吗？}
    B -- 有 --> C[必须使用 await ✅]
    
    B -- 没有 --> D{第二步：看返回类型提示<br>返回 Coroutine/Task/Future?}
    D -- 是 --> C
    
    D -- 否 --> E{第三步：想操作类型<br>是 I/O 或等待操作吗？<br>网络/文件/数据库/睡眠?}
    E -- 是 --> F[查阅文档确认<br>通常需要 await ✅]
    
    E -- 否 --> G{第四步：上下文判断<br>在 async def 函数内吗？}
    G -- 是 --> H[保持警惕，仔细检查]
    G -- 否 --> I[可能不需要 await]
    
    F --> C
    H --> J[按同步方式写]
```

![[deepseek_mermaid_20251209_905aa5.svg]]

```
flowchart TD
    A[MCP ChatBot 启动] --> B[读取 server_config.json]
    
    B --> C1[连接 filesystem 服务器<br>command: npx ...]
    B --> C2[连接 fetch 服务器<br>command: uvx ...]
    B --> C3[连接 research 服务器<br>command: uv run ...]
    
    subgraph C1_Process [filesystem 服务器启动流程]
        D1[npx 检查本地缓存] --> E1{本地有包?}
        E1 -- 是 --> F1[使用本地缓存]
        E1 -- 否 --> G1[从 npm 仓库下载] --> F1
        F1 --> H1[启动文件系统服务器<br>根目录: .]
    end
    
    subgraph C2_Process [fetch 服务器启动流程]
        D2[uvx 检查本地缓存] --> E2{本地有包?}
        E2 -- 是 --> F2[使用本地缓存]
        E2 -- 否 --> G2[从 PyPI 仓库下载] --> F2
        F2 --> H2[启动网页抓取服务器]
    end
    
    subgraph C3_Process [research 服务器启动流程]
        D3[uv 加载本地 Python 环境] --> E3{本地 research_server.py 存在?}
        E3 -- 是 --> H3[启动你的自定义服务器]
        E3 -- 否 --> Z[连接失败，报错]
    end
    
    H1 & H2 & H3 --> I[MCP协议通信<br>机器人获取工具列表]
    I --> J[用户提问<br>模型调用相关工具]
    
    J --> K1[文件操作]
    J --> K2[网页抓取]
    J --> K3[自定义研究]
```

![[deepseek_mermaid_20251209_7a4dbc.svg]]